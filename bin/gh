#!/usr/bin/env bash
set -e

usage() {
  echo "
  usage: $(basename $0) [options]

  Open the current Git repository in a browser.

  options:

    --default-branch <branch-name>
"
}

get_identifier() {
  git config --get "remote.$1.url" \
  | sed -E 's!^([^@]*@([^:]*):|https://([^/]*)/)(.*)[.]git$!\2\3/\4!'
}

# If refs/heads/master exists, returns "master";
# else if refs/heads/gh-pages exists, returns "gh-pages";
# else returns "master".
get_default_branch() {
  local ref
  for ref in $(git for-each-ref --format='%(refname)' refs/heads | sort -r) ; do
    [ "$ref" = 'refs/heads/master' ] && printf master && exit
    [ "$ref" = 'refs/heads/gh-pages' ] && printf gh-pages && exit
  done
  printf master
}

origin_identifier="$(get_identifier origin)"
upstream_identifier="$(get_identifier upstream)"
default_branch="$(get_default_branch)"
current_branch="$(git rev-parse --abbrev-ref HEAD)"
case "$1" in
  -h|--help) usage ; exit ;;
  --default-branch) default_branch="$2" ;;
  -*) echo "invalid argument $1" >&2 ; exit 1 ;;
esac
if [ -n "$upstream_identifier" ] ; then
  open "https://$origin_identifier/compare/$(cut -d / -f 2 <<<"$upstream_identifier"):$default_branch...$current_branch"
elif [ "$current_branch" = "$default_branch" ] ; then
  open "https://$origin_identifier/commits/$default_branch"
else
  open "https://$origin_identifier/compare/$default_branch...$current_branch"
fi
